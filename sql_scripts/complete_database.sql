PRAGMA foreign_keys = OFF;
BEGIN TRANSACTION;

-- Удаление существующих таблиц (если есть)
DROP TABLE IF EXISTS appointments_workouts;
DROP TABLE IF EXISTS trainers_workouts;
DROP TABLE IF EXISTS appointments;
DROP TABLE IF EXISTS clients;
DROP TABLE IF EXISTS workouts;
DROP TABLE IF EXISTS trainers;

-- Создание таблицы "Тренера"
CREATE TABLE trainers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    last_name TEXT NOT NULL,
    first_name TEXT NOT NULL,
    middle_name TEXT NOT NULL,
    name_of_training_session TEXT NOT NULL,
    phone TEXT,
    email TEXT,
    specialization TEXT,
    experience_years INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Создание таблицы "Тренировки"
CREATE TABLE workouts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name_of_training_session TEXT NOT NULL,
    last_name TEXT NOT NULL,
    first_name TEXT NOT NULL,
    middle_name TEXT NOT NULL,
    description TEXT,
    duration_minutes INTEGER DEFAULT 60,
    max_participants INTEGER DEFAULT 10,
    difficulty_level TEXT CHECK(difficulty_level IN ('Начинающий', 'Средний', 'Продвинутый')),
    price DECIMAL(10,2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Создание таблицы "Клиенты"
CREATE TABLE clients (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    last_name TEXT NOT NULL,
    first_name TEXT NOT NULL,
    middle_name TEXT NOT NULL,
    phone TEXT NOT NULL UNIQUE,
    name_of_training_session TEXT NOT NULL,
    email TEXT,
    birth_date DATE,
    membership_type TEXT CHECK(membership_type IN ('Разовый', 'Месячный', 'Годовой')),
    registration_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Создание таблицы "Запись на тренировки"
CREATE TABLE appointments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    last_name TEXT NOT NULL,
    first_name TEXT NOT NULL,
    phone TEXT NOT NULL,
    date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    trener_id INTEGER,
    name_of_training_session TEXT NOT NULL,
    comment TEXT,
    status TEXT DEFAULT 'Запланировано' CHECK(status IN ('Запланировано', 'Проведено', 'Отменено')),
    appointment_date DATETIME,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (trener_id) REFERENCES trainers(id) ON DELETE SET NULL
);

-- Создание связующей таблицы тренеров и тренировок
CREATE TABLE trainers_workouts (
    trener_id INTEGER,
    workout_id INTEGER,
    PRIMARY KEY (trener_id, workout_id),
    FOREIGN KEY (trener_id) REFERENCES trainers(id) ON DELETE CASCADE,
    FOREIGN KEY (workout_id) REFERENCES workouts(id) ON DELETE CASCADE
);

-- Создание связующей таблицы записей и тренировок
CREATE TABLE appointments_workouts (
    appointment_id INTEGER,
    workout_id INTEGER,
    PRIMARY KEY (appointment_id, workout_id),
    FOREIGN KEY (appointment_id) REFERENCES appointments(id) ON DELETE CASCADE,
    FOREIGN KEY (workout_id) REFERENCES workouts(id) ON DELETE CASCADE
);

-- Добавление данных о тренерах (30 записей)
INSERT INTO trainers (last_name, first_name, middle_name, name_of_training_session, phone, email, specialization, experience_years) VALUES
('Иванов', 'Александр', 'Петрович', 'Йога', '+7(999)111-11-11', 'ivanov@fitness.ru', 'Йога и медитация', 5),
('Петрова', 'Мария', 'Сергеевна', 'Пилатес', '+7(999)222-22-22', 'petrova@fitness.ru', 'Пилатес и растяжка', 3),
('Сидоров', 'Дмитрий', 'Александрович', 'Кроссфит', '+7(999)333-33-33', 'sidorov@fitness.ru', 'Кроссфит и функциональный тренинг', 7),
('Козлова', 'Елена', 'Владимировна', 'Стретчинг', '+7(999)444-44-44', 'kozlova@fitness.ru', 'Растяжка и гибкость', 4),
('Новиков', 'Сергей', 'Игоревич', 'Бодибилдинг', '+7(999)555-55-55', 'novikov@fitness.ru', 'Силовые тренировки', 8),
('Морозова', 'Анна', 'Дмитриевна', 'Кардио', '+7(999)666-66-66', 'morozova@fitness.ru', 'Кардио и выносливость', 6),
('Волков', 'Игорь', 'Сергеевич', 'Бокс', '+7(999)777-77-77', 'volkov@fitness.ru', 'Боевые искусства', 10),
('Соколова', 'Ольга', 'Андреевна', 'Танцы', '+7(999)888-88-88', 'sokolova@fitness.ru', 'Танцевальная аэробика', 4),
('Лебедев', 'Павел', 'Николаевич', 'Плавание', '+7(999)999-99-99', 'lebedev@fitness.ru', 'Плавание и аквааэробика', 9),
('Козлова', 'Наталья', 'Ивановна', 'Аэробика', '+7(999)000-00-00', 'kozlova.n@fitness.ru', 'Аэробика и степ', 5),
('Смирнов', 'Андрей', 'Петрович', 'Кикбоксинг', '+7(999)111-22-33', 'smirnov@fitness.ru', 'Кикбоксинг и тайский бокс', 6),
('Попова', 'Юлия', 'Александровна', 'Зумба', '+7(999)222-33-44', 'popova@fitness.ru', 'Зумба и латиноамериканские танцы', 3),
('Васильев', 'Владимир', 'Сергеевич', 'Тяжелая атлетика', '+7(999)333-44-55', 'vasiliev@fitness.ru', 'Тяжелая атлетика и пауэрлифтинг', 12),
('Семенова', 'Татьяна', 'Игоревна', 'Функциональный тренинг', '+7(999)444-55-66', 'semenova@fitness.ru', 'Функциональный тренинг', 7),
('Голубев', 'Михаил', 'Дмитриевич', 'Бег', '+7(999)555-66-77', 'golubev@fitness.ru', 'Бег и марафон', 8),
('Виноградова', 'Екатерина', 'Андреевна', 'Степ-аэробика', '+7(999)666-77-88', 'vinogradova@fitness.ru', 'Степ-аэробика', 4),
('Белов', 'Артем', 'Сергеевич', 'Карате', '+7(999)777-88-99', 'belov@fitness.ru', 'Карате и самооборона', 9),
('Медведева', 'Ирина', 'Петровна', 'Пилатес', '+7(999)888-99-00', 'medvedeva@fitness.ru', 'Пилатес и йога', 6),
('Алексеев', 'Денис', 'Николаевич', 'Тренажерный зал', '+7(999)999-00-11', 'alekseev@fitness.ru', 'Тренажерный зал и персональные тренировки', 11),
('Лебедева', 'Светлана', 'Ивановна', 'Йога', '+7(999)000-11-22', 'lebedeva@fitness.ru', 'Йога и медитация', 5),
('Соколов', 'Роман', 'Андреевич', 'Кроссфит', '+7(999)111-33-44', 'sokolov@fitness.ru', 'Кроссфит и HIIT', 4),
('Новикова', 'Алена', 'Сергеевна', 'Стретчинг', '+7(999)222-44-55', 'novikova@fitness.ru', 'Стретчинг и пилатес', 3),
('Морозов', 'Алексей', 'Дмитриевич', 'Бодибилдинг', '+7(999)333-55-66', 'morozov@fitness.ru', 'Бодибилдинг и фитнес', 7),
('Волкова', 'Людмила', 'Петровна', 'Кардио', '+7(999)444-66-77', 'volkova@fitness.ru', 'Кардио и аэробика', 5),
('Попов', 'Станислав', 'Игоревич', 'Бокс', '+7(999)555-77-88', 'popov@fitness.ru', 'Бокс и кикбоксинг', 8),
('Семенова', 'Марина', 'Александровна', 'Танцы', '+7(999)666-88-99', 'semenova.m@fitness.ru', 'Танцы и хореография', 6),
('Голубев', 'Виктор', 'Сергеевич', 'Плавание', '+7(999)777-99-00', 'golubev.v@fitness.ru', 'Плавание и водные виды спорта', 7),
('Виноградова', 'Оксана', 'Николаевна', 'Аэробика', '+7(999)888-00-11', 'vinogradova.o@fitness.ru', 'Аэробика и фитнес', 4),
('Белов', 'Григорий', 'Дмитриевич', 'Кикбоксинг', '+7(999)999-11-22', 'belov.g@fitness.ru', 'Кикбоксинг и MMA', 8);

-- Добавление данных о тренировках (20 записей)
INSERT INTO workouts (name_of_training_session, last_name, first_name, middle_name, description, duration_minutes, max_participants, difficulty_level, price) VALUES
('Йога для начинающих', 'Иванов', 'Александр', 'Петрович', 'Мягкая практика для новичков', 60, 15, 'Начинающий', 800.00),
('Пилатес', 'Петрова', 'Мария', 'Сергеевна', 'Укрепление мышц кора', 45, 12, 'Средний', 1000.00),
('Кроссфит', 'Сидоров', 'Дмитрий', 'Александрович', 'Высокоинтенсивные тренировки', 60, 10, 'Продвинутый', 1200.00),
('Стретчинг', 'Козлова', 'Елена', 'Владимировна', 'Растяжка и гибкость', 45, 20, 'Начинающий', 600.00),
('Бодибилдинг', 'Новиков', 'Сергей', 'Игоревич', 'Набор мышечной массы', 90, 8, 'Продвинутый', 1500.00),
('Кардио-тренировка', 'Морозова', 'Анна', 'Дмитриевна', 'Улучшение выносливости', 45, 15, 'Средний', 800.00),
('Бокс', 'Волков', 'Игорь', 'Сергеевич', 'Техника ударов и защита', 60, 12, 'Средний', 1000.00),
('Танцевальная аэробика', 'Соколова', 'Ольга', 'Андреевна', 'Танцы под музыку', 45, 18, 'Начинающий', 700.00),
('Плавание', 'Лебедев', 'Павел', 'Николаевич', 'Техника плавания', 60, 8, 'Средний', 900.00),
('Степ-аэробика', 'Козлова', 'Наталья', 'Ивановна', 'Тренировка на степ-платформе', 45, 16, 'Средний', 750.00),
('Кикбоксинг', 'Смирнов', 'Андрей', 'Петрович', 'Комбинация бокса и карате', 60, 10, 'Продвинутый', 1100.00),
('Зумба', 'Попова', 'Юлия', 'Александровна', 'Латиноамериканские танцы', 45, 20, 'Начинающий', 650.00),
('Тяжелая атлетика', 'Васильев', 'Владимир', 'Сергеевич', 'Работа с весами', 90, 6, 'Продвинутый', 1600.00),
('Функциональный тренинг', 'Семенова', 'Татьяна', 'Игоревна', 'Комплексные упражнения', 60, 12, 'Средний', 950.00),
('Беговая тренировка', 'Голубев', 'Михаил', 'Дмитриевич', 'Техника бега', 45, 15, 'Средний', 700.00),
('Степ-аэробика продвинутый', 'Виноградова', 'Екатерина', 'Андреевна', 'Сложные комбинации', 60, 12, 'Продвинутый', 1000.00),
('Карате', 'Белов', 'Артем', 'Сергеевич', 'Боевое искусство', 60, 14, 'Средний', 900.00),
('Пилатес продвинутый', 'Медведева', 'Ирина', 'Петровна', 'Сложные упражнения', 60, 10, 'Продвинутый', 1200.00),
('Тренажерный зал', 'Алексеев', 'Денис', 'Николаевич', 'Индивидуальные тренировки', 60, 1, 'Средний', 2000.00),
('Йога продвинутый', 'Лебедева', 'Светлана', 'Ивановна', 'Сложные асаны', 75, 12, 'Продвинутый', 1100.00);

-- Добавление данных о клиентах (20 записей)
INSERT INTO clients (last_name, first_name, middle_name, phone, name_of_training_session, email, birth_date, membership_type) VALUES
('Смирнова', 'Анна', 'Ивановна', '+7(999)123-45-67', 'Йога', 'smirnova@email.ru', '1990-05-15', 'Месячный'),
('Петров', 'Иван', 'Сергеевич', '+7(999)234-56-78', 'Пилатес', 'petrov@email.ru', '1985-08-22', 'Годовой'),
('Козлов', 'Петр', 'Александрович', '+7(999)345-67-89', 'Кроссфит', 'kozlov@email.ru', '1992-12-03', 'Разовый'),
('Новикова', 'Елена', 'Владимировна', '+7(999)456-78-90', 'Стретчинг', 'novikova@email.ru', '1988-03-18', 'Месячный'),
('Сидоров', 'Сергей', 'Игоревич', '+7(999)567-89-01', 'Бодибилдинг', 'sidorov@email.ru', '1983-07-25', 'Годовой'),
('Морозов', 'Александр', 'Дмитриевич', '+7(999)678-90-12', 'Кардио', 'morozov@email.ru', '1995-01-10', 'Разовый'),
('Волкова', 'Мария', 'Сергеевна', '+7(999)789-01-23', 'Бокс', 'volkova@email.ru', '1991-09-14', 'Месячный'),
('Лебедев', 'Дмитрий', 'Николаевич', '+7(999)890-12-34', 'Танцы', 'lebedev@email.ru', '1987-11-30', 'Годовой'),
('Соколова', 'Ольга', 'Андреевна', '+7(999)901-23-45', 'Плавание', 'sokolova@email.ru', '1993-04-07', 'Разовый'),
('Алексеев', 'Павел', 'Сергеевич', '+7(999)012-34-56', 'Аэробика', 'alekseev@email.ru', '1989-06-20', 'Месячный'),
('Попова', 'Наталья', 'Ивановна', '+7(999)123-45-78', 'Кикбоксинг', 'popova@email.ru', '1994-02-28', 'Годовой'),
('Васильев', 'Андрей', 'Петрович', '+7(999)234-56-89', 'Зумба', 'vasiliev@email.ru', '1986-10-12', 'Разовый'),
('Семенов', 'Игорь', 'Александрович', '+7(999)345-67-90', 'Тяжелая атлетика', 'semenov@email.ru', '1984-08-05', 'Месячный'),
('Голубева', 'Татьяна', 'Сергеевна', '+7(999)456-78-01', 'Функциональный тренинг', 'golubeva@email.ru', '1992-12-15', 'Годовой'),
('Виноградов', 'Михаил', 'Дмитриевич', '+7(999)567-89-12', 'Бег', 'vinogradov@email.ru', '1988-05-03', 'Разовый'),
('Белова', 'Екатерина', 'Андреевна', '+7(999)678-90-23', 'Степ-аэробика', 'belova@email.ru', '1990-07-18', 'Месячный'),
('Медведев', 'Артем', 'Петрович', '+7(999)789-01-34', 'Карате', 'medvedev@email.ru', '1985-11-22', 'Годовой'),
('Лебедева', 'Ирина', 'Николаевна', '+7(999)890-12-45', 'Пилатес', 'lebedeva@email.ru', '1993-03-09', 'Разовый'),
('Соколов', 'Роман', 'Сергеевич', '+7(999)901-23-56', 'Тренажерный зал', 'sokolov@email.ru', '1987-09-26', 'Месячный'),
('Новиков', 'Алена', 'Ивановна', '+7(999)012-34-67', 'Йога', 'novikov@email.ru', '1991-01-13', 'Годовой');

-- Связывание тренеров и тренировок
INSERT INTO trainers_workouts (trener_id, workout_id) VALUES
(1, 1), (1, 20), (2, 2), (2, 18), (3, 3), (4, 4), (5, 5), (6, 6), (7, 7), (8, 8),
(9, 9), (10, 10), (10, 16), (11, 11), (12, 12), (13, 13), (14, 14), (15, 15),
(16, 16), (17, 17), (18, 18), (19, 19), (20, 20), (21, 3), (22, 4), (23, 5),
(24, 6), (25, 7), (26, 8), (27, 9), (28, 10), (29, 11), (30, 1);

-- Добавление записей на тренировки (4 записи)
INSERT INTO appointments (last_name, first_name, phone, trener_id, name_of_training_session, comment, status, appointment_date) VALUES
('Смирнова', 'Анна', '+7(999)123-45-67', 1, 'Йога для начинающих', 'Первый раз на йоге, нужна помощь', 'Запланировано', '2024-09-01 10:00:00'),
('Петров', 'Иван', '+7(999)234-56-78', 2, 'Пилатес', 'Регулярные занятия', 'Запланировано', '2024-09-02 18:00:00'),
('Козлов', 'Петр', '+7(999)345-67-89', 3, 'Кроссфит', 'Интенсивная тренировка', 'Проведено', '2024-08-30 19:00:00'),
('Новикова', 'Елена', '+7(999)456-78-90', 4, 'Стретчинг', 'Восстановление после травмы', 'Запланировано', '2024-09-03 16:00:00');

-- Связывание записей и тренировок
INSERT INTO appointments_workouts (appointment_id, workout_id) VALUES
(1, 1), (2, 2), (3, 3), (4, 4);

-- =====================================================
-- СОЗДАНИЕ ИНДЕКСОВ ДЛЯ ОПТИМИЗАЦИИ
-- =====================================================

-- Индекс для быстрого поиска тренеров по фамилии
-- Ускоряет поиск тренеров при фильтрации по фамилии
CREATE INDEX idx_trainers_last_name ON trainers(last_name);

-- Индекс для быстрого поиска клиентов по телефону
-- Ускоряет поиск клиентов по номеру телефона
CREATE INDEX idx_clients_phone ON clients(phone);

-- Составной индекс для поиска записей по телефону и дате
-- Ускоряет поиск записей конкретного клиента на определенную дату
CREATE INDEX idx_appointments_phone_date ON appointments(phone, appointment_date);

-- Составной индекс для поиска тренировок по уровню сложности и цене
-- Ускоряет фильтрацию тренировок по сложности и ценовому диапазону
CREATE INDEX idx_workouts_difficulty_price ON workouts(difficulty_level, price);

-- Индекс для поиска записей по статусу
-- Ускоряет получение списка записей по статусу (запланировано, проведено, отменено)
CREATE INDEX idx_appointments_status ON appointments(status);

-- Индекс для поиска тренеров по специализации
-- Ускоряет поиск тренеров по их специализации
CREATE INDEX idx_trainers_specialization ON trainers(specialization);

COMMIT;
PRAGMA foreign_keys = ON;